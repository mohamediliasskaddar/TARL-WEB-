<h2>Create a New Test</h2>

<form [formGroup]="testForm" (ngSubmit)="submitTest()">

  <!-- Title -->
  <label>Title</label>
  <input type="text" formControlName="title" placeholder="Test title" />

  <!-- Classroom selector -->
  <label>Classroom</label>
  <select formControlName="classroomId">
    <option *ngFor="let grade of gradeLevels" [value]="grade">
      {{ grade }}
    </option>
  </select>

  <!-- Draft toggle -->
  <label>
    <input type="checkbox" formControlName="isDraft" />
    Make the test a draft
  </label>

  <!-- Special-test toggle -->
  <label>
    <input type="checkbox" formControlName="isSpecial" />
    Special test
  </label>

  <!-- Student selection, only when special -->
  <div *ngIf="testForm.get('isSpecial')!.value">
    <label>Select students:</label>
    <div *ngFor="let stu of availableStudents">
      <label>
        <input
          #stuCb
          type="checkbox"
          [checked]="selectedStudentIds.includes(stu.id)"
          (change)="onStudentToggle(stu.id, stuCb.checked)"
        />
        {{ stu.name }}
      </label>
    </div>
  </div>

  <!-- Test duration -->
  <label>Test Duration (minutes)</label>
  <input type="number" formControlName="testDuration" />

  <hr />

  <!-- Mini-game selection -->
  <label>Select Mini-Games</label>
  <div *ngFor="let game of allMiniGames">
    <div *ngIf="isGradeInRange(game.suggestedGradeRange, testForm.get('classroomId')!.value)">
      <label>
        <input
          #gameCb
          type="checkbox"
          [checked]="selectedMiniGameIds.includes(game.id)"
          (change)="onMiniGameToggle(game.id, gameCb.checked)"
        />
        {{ game.title }}
      </label>
    </div>
  </div>

  <hr />

  <!-- Mini-game configurations -->
  <div formGroupName="miniGameConfigs">
    <div *ngFor="let gameId of selectedMiniGameIds">
      <h4>{{ gameId.replace('_', ' ') | titlecase }} Configuration</h4>
      <div [formGroupName]="gameId">

        <!-- General config keys -->
        <div *ngFor="let controlKey of getControlKeys(gameId)">
          <label>{{ controlKey }}</label>
          <input type="text" [formControlName]="controlKey" />
        </div>

        <!-- Dynamic steps for multi_step_problem -->
        <!-- <div *ngIf="gameId === 'multi_step_problem'">
        <div *ngFor="let i of getStepIndexes(gameId)">
          <label>Step {{ i + 1 }} – Question</label>
          <input
            type="text"
            [formControlName]="'step' + (i + 1) + '_question'"
            placeholder="Question {{ i + 1 }}"
          />

          <label>Step {{ i + 1 }} – Answer</label>
          <input
            type="text"
            [formControlName]="'step' + (i + 1) + '_answer'"
            placeholder="Answer {{ i + 1 }}"
          />
        </div>
      </div> -->

      </div>
    </div>
  </div>

  <!-- Submit -->
  <button type="submit">Save Test</button>
</form>