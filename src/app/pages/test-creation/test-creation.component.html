<h2>Create a New Test</h2>

<form [formGroup]="testForm" (ngSubmit)="submitTest()">

  <!-- Title -->
  <label>Title</label>
  <input type="text" formControlName="title" placeholder="Test title" />

  <!-- Draft -->
  <label>
    <input type="checkbox" formControlName="isDraft" />
    Make the test a draft
  </label>

  <!-- Special -->
  <label>
    <input type="checkbox" formControlName="isSpecial" />
    Special test
  </label>

  <!-- Student selection (only if special) -->
  <div *ngIf="testForm.get('isSpecial')!.value">
    <label>Select students:</label>
    <div *ngFor="let stu of availableStudents">
      <label>
        <input
          #cb
          type="checkbox"
          [checked]="selectedStudentIds.includes(stu.id)"
          (change)="onStudentToggle(stu.id, $any(cb).checked)"
        />
        {{ stu.name }}
      </label>
    </div>
  </div>

  <!-- Classroom -->
  <label>Classroom</label>
  <select formControlName="classroomId">
    <option *ngFor="let grade of gradeLevels" [value]="grade">
      {{ grade }}
    </option>
  </select>

  <!-- Duration -->
  <label>Test Duration (minutes)</label>
  <input type="number" formControlName="testDuration" />

  <hr />

  <!-- Mini-Games selection -->
  <label>Select Mini-Games</label>
  <div *ngFor="let game of allMiniGames">
    <div *ngIf="isGradeInRange(game.suggestedGradeRange, testForm.get('classroomId')!.value)">
      <label>
        <input
          type="checkbox"
          [checked]="selectedMiniGameIds.includes(game.id)"
          (change)="onMiniGameToggle(game.id, $any($event.target).checked)"
        />
        {{ game.title }}
      </label>
    </div>
  </div>

  <hr />

  <!-- Mini-Game Configs -->
  <div formGroupName="miniGameConfigs">
    <div *ngFor="let gameId of selectedMiniGameIds">
      <h4>{{ gameId.replace('_', ' ') | titlecase }} Configuration</h4>
      <div [formGroupName]="gameId">
        <div *ngFor="let kv of testForm.get('miniGameConfigs')!.get(gameId)!.value | keyvalue">
          <label>{{ kv.key }}</label>
          <input
            type="text"
            [formControlName]="$any(kv.key)"
          />
        </div>
      </div>
    </div>
  </div>

  <button type="submit">Save Test</button>
</form>
